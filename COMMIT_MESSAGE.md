# Исправление авторизации в EMQX и настройка трейсинга для Observability

## Описание проблем и их решение

### 1. Проблема с авторизацией в EMQX

**Обнаружена проблема:** После обновления EMQX до версии 5.10.0 (latest) перестала корректно работать аутентификация для mTLS устройств.

**Причина:** Изменение формата конфигурации в EMQX 5.10.0 по сравнению с версией 5.3.0, указанной в `docker-compose.yml`.

**Решение:**

- Обновлен файл `emqx-mtls.conf` для совместимости с форматом конфигурации EMQX 5.10.0
- Добавлена минимальная настройка глобальной аутентификации для совместимости:

```hocon
authentication = [
  {
    mechanism = password_based
    backend = built_in_database
    enable = false
  }
]
```

- Сохранена настройка аутентификации для SSL слушателя с проверкой mTLS сертификатов
- Проверено успешное подключение устройств через SSL порт с клиентскими сертификатами

### 2. Улучшение отображения трейсов в Grafana

**Обнаружена проблема:** Панель трейсов и карта сервисов в Grafana не отображали актуальные трейсы.

**Решение:**

- Обновлены TraceQL-запросы в Grafana дашборде:

```traceql
{.service.name = "iot-hub-backend"} | sort @startTimeUnixNano desc | limit 1
```

- Изменены запросы для отображения последнего трейса вместо захардкоженного ID трейса
- Обеспечена автоматическая актуализация данных на панелях трейсов

## Технические детали изменений

### EMQX авторизация

- **Файл:** `/home/noise83/Projects/Nodejs/iot-hub/emqx-mtls.conf`
- **Изменения:**
  - Добавлена глобальная аутентификация для совместимости с EMQX 5.10.0
  - Сохранены настройки аутентификации для SSL слушателя с HTTP валидацией сертификатов
  - Оставлена конфигурация с отключенной аутентификацией для TCP соединений (backend)

### Настройка трейсинга

- **Файл:** `/home/noise83/Projects/docker/LokiGrafana/iot-hub-dashboard.json`
- **Изменения:**
  - Обновлены запросы TraceQL для панели трейсов и карты сервисов
  - Добавлены динамические запросы для отображения последнего трейса вместо статического ID

### Мониторинг и Observability

- Исправлена интеграция EMQX с OpenTelemetry для отправки телеметрии
- Проверено корректное отображение метрик и логов в Grafana
- Подтверждена работа mTLS аутентификации для IoT устройств
- Оптимизированы запросы для отображения самых актуальных данных в дашборде

## Тестирование

- Подтверждено успешное подключение тестовых устройств через mTLS (устройство mTLS-test-device-1751608502710)
- Проверена корректная работа аутентификации для устройств с сертификатами
- Проверено прохождение трейсов от backend приложения в Tempo

## Следующие шаги

- Рассмотреть возможность фиксации версии EMQX в docker-compose.yml для предотвращения подобных проблем в будущем
- Оптимизировать запросы для отображения нескольких последних трейсов в Grafana дашборде
- Добавить дополнительные метрики для мониторинга состояния подключений MQTT устройств
