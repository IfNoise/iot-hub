# feat: –ù–∞—Å—Ç—Ä–æ–π–∫–∞ EMQX mTLS –∏ —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã—Ö API –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤

## üîê EMQX mTLS –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞

### –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ EMQX

- **–£–¥–∞–ª–µ–Ω—ã —É—Å—Ç–∞—Ä–µ–≤—à–∏–µ –ø–æ–ª—è** –∏–∑ `emqx-mtls.conf` –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å EMQX 5.3.0
- **–£–±—Ä–∞–Ω—ã deprecated —Å–µ–∫—Ü–∏–∏**: authentication, authorization, logging, zones, mqtt
- **–ù–∞—Å—Ç—Ä–æ–µ–Ω–∞ SSL –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è** –¥–ª—è mTLS (–ø–æ—Ä—Ç 8883)
- **–î–æ–±–∞–≤–ª–µ–Ω—ã –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è**: node.name, node.cookie, node.data_dir
- **–û—Ç–∫–ª—é—á–µ–Ω WSS listener** (8084) –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –æ—à–∏–±–æ–∫ –∑–∞–ø—É—Å–∫–∞

### Docker Compose –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è

- **–û–±–Ω–æ–≤–ª–µ–Ω—ã –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è** EMQX: EMQX_NODE__COOKIE, EMQX_LISTENERS__WSS__DEFAULT__ENABLE=false
- **–£–¥–∞–ª–µ–Ω—ã –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ** –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- **–£—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫** –≤—Å–µ—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤: emqx-mtls, iot-postgres, iot-redis

### –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤

- **–°–∫—Ä–∏–ø—Ç `generate-emqx-certs.sh`** –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- **–ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤** –≤ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ (certs/ –∏ apps/backend/certs/)
- **–ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö DNS/IP** –≤ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞—Ö (localhost, emqx, emqx-mtls, 127.0.0.1, 172.20.0.2)

## üìö –°–æ–∑–¥–∞–Ω–∏–µ API –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ (5 –±–∏–±–ª–∏–æ—Ç–µ–∫)

### @iot-hub/users - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏

- **7 —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤**: CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏, –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞ –∏ –ø–ª–∞–Ω–æ–≤
- **Zod —Å—Ö–µ–º—ã**: CreateUser, UpdateUser, UserBase —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π

### @iot-hub/devices - IoT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

- **8 —ç–Ω–¥–ø–æ–∏–Ω—Ç–æ–≤**: —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è, –ø—Ä–∏–≤—è–∑–∫–∞, —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞–º–∏
- **Device lifecycle**: unbound ‚Üí bound ‚Üí revoked —Å –ø–æ–ª–Ω–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π

### @iot-hub/mqtt - MQTT RPC –∫–æ–º–∞–Ω–¥—ã

- **2 —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞**: command –∏ command/no-response
- **8 RPC –º–µ—Ç–æ–¥–æ–≤**: getDeviceState, getSensors, reboot, updateTimers, updateRegulators, updateIrrigator

### @iot-hub/auth - –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è

- **4 —ç–Ω–¥–ø–æ–∏–Ω—Ç–∞**: –ø—Ä–æ—Ñ–∏–ª—å, OAuth2 Proxy –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è, —Ä–æ–ª–∏ admin/user

### @iot-hub/crypto - –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

- **–°—Ö–µ–º—ã —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤**: CSR, –ø–æ–¥–ø–∏—Å–∞–Ω–∏–µ, –≤–∞–ª–∏–¥–∞—Ü–∏—è fingerprint

## üõ†Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ @iot-hub/shared –±–∏–±–ª–∏–æ—Ç–µ–∫–∏

### –ü–µ—Ä–µ–Ω–æ—Å –∏–∑ iot-core

- **RPC —É—Ç–∏–ª–∏—Ç—ã**: getRequestTopic, createRpcRequest, RpcErrors
- **–¢–∏–ø—ã**: RpcRequest, RpcResponse, DeviceInfo, UserInfo, CertificateInfo
- **–ö–æ–Ω—Å—Ç–∞–Ω—Ç—ã**: MQTT_TOPICS, RPC_ERROR_CODES, TIMEOUTS, —Å—Ç–∞—Ç—É—Å—ã

### –ù–æ–≤—ã–π MQTT RPC –∫–ª–∏–µ–Ω—Ç (354 —Å—Ç—Ä–æ–∫–∏)

- **Promise-based API** –≤–º–µ—Å—Ç–æ callback
- **–ü–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è** –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤
- **–ù–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ** –æ—Ç BaseMqttClient
- **–ú–µ—Ç–æ–¥—ã**: connect, sendCommand, sendCommandWithResponse, subscribeToResponses

### Infrastructure

- **BaseMqttClient** - –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å –¥–ª—è –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
- **MqttRpcClient** - –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å —Å–æ–±—ã—Ç–∏—è–º–∏
- **–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º** –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∏ –æ—á–∏—Å—Ç–∫–∞ —Ä–µ—Å—É—Ä—Å–æ–≤

## üîÑ –ú–∏–≥—Ä–∞—Ü–∏—è backend —Å iot-core

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ DTO (12 —Ñ–∞–π–ª–æ–≤)

- **Users**: CreateUserDto, UpdateUserDto, UserResponseDto ‚Üí @iot-hub/users
- **Devices**: CreateDeviceDto, BindDeviceDto ‚Üí @iot-hub/devices  
- **MQTT**: DeviceCommandDto ‚Üí @iot-hub/mqtt —Å—Ö–µ–º—ã
- **Entity**: User.entity ‚Üí enum'—ã –∏–∑ @iot-hub/users

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–≤

- **MqttRpcService**: –∑–∞–º–µ–Ω–∞ MqttRpcClient —Å iot-core –Ω–∞ @iot-hub/shared
- **–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Ç–æ–¥–æ–≤**: onConnect() ‚Üí on('connect'), sendCommandAsync() ‚Üí sendCommandWithResponse()

### TypeScript –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

- **–û–±–Ω–æ–≤–ª–µ–Ω—ã –ø—É—Ç–∏** –≤ tsconfig.base.json: —É–¥–∞–ª–µ–Ω—ã iot-core, –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
- **Project references** –≤ tsconfig.json –∏ tsconfig.app.json
- **–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞** —Å rootDir –≤ libs/contracts/users/tsconfig.lib.json

## üìä –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏

### –°–æ–∑–¥–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- **6 –±–∏–±–ª–∏–æ—Ç–µ–∫**: 5 –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ + 1 shared
- **21 API —ç–Ω–¥–ø–æ–∏–Ω—Ç** —Å –ø–æ–ª–Ω–æ–π —Ç–∏–ø–∏–∑–∞—Ü–∏–µ–π
- **~3000+ —Å—Ç—Ä–æ–∫ –∫–æ–¥–∞** –≤—ã—Å–æ–∫–æ–≥–æ –∫–∞—á–µ—Å—Ç–≤–∞
- **8 MQTT RPC –º–µ—Ç–æ–¥–æ–≤** –¥–ª—è IoT —É—Å—Ç—Ä–æ–π—Å—Ç–≤

### –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **TS-REST**: —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ API –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã
- **Zod**: –≤–∞–ª–∏–¥–∞—Ü–∏—è –Ω–∞ —É—Ä–æ–≤–Ω–µ —Å—Ö–µ–º  
- **TypeScript 5.x**: —Å—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- **Nx –º–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π**: –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å–±–æ—Ä–∫–∞
- **MQTT 5.x**: —Å mTLS –¥–ª—è production security

### Quality gates

- ‚úÖ **–°–±–æ—Ä–∫–∞**: –≤—Å–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ —Å–æ–±–∏—Ä–∞—é—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫
- ‚úÖ **–õ–∏–Ω—Ç–∏–Ω–≥**: –∫–æ–¥ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—Ç–∞–Ω–¥–∞—Ä—Ç–∞–º  
- ‚úÖ **–¢–∏–ø–∏–∑–∞—Ü–∏—è**: —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã –≤—Å–µ any —Ç–∏–ø—ã
- ‚úÖ **EMQX**: —É—Å–ø–µ—à–Ω—ã–π –∑–∞–ø—É—Å–∫ —Å mTLS
- ‚úÖ **–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã**: –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è

## üéØ –î–æ—Å—Ç–∏–≥–Ω—É—Ç—ã–µ —Ü–µ–ª–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- **mTLS –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è** –º–µ–∂–¥—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏ –∏ EMQX
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è** —Å–µ—Ä–≤–µ—Ä–Ω—ã—Ö —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
- **JWT –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è** —á–µ—Ä–µ–∑ MQTT username/password

### –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞  

- **–¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã** –¥–ª—è –≤—Å–µ—Ö API
- **–ú–æ–¥—É–ª—å–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** —Å —á–µ—Ç–∫–∏–º —Ä–∞–∑–¥–µ–ª–µ–Ω–∏–µ–º –¥–æ–º–µ–Ω–æ–≤
- **–ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã** –≤ shared –±–∏–±–ª–∏–æ—Ç–µ–∫–µ
- **–ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞–º** —á–µ—Ä–µ–∑ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã

### Developer Experience

- **100% —Ç–∏–ø–∏–∑–∞—Ü–∏—è** API –∑–∞–ø—Ä–æ—Å–æ–≤/–æ—Ç–≤–µ—Ç–æ–≤
- **–ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ** –≤ IDE –¥–ª—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤
- **Compile-time –≤–∞–ª–∏–¥–∞—Ü–∏—è** –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
- **–°—Ç–∞–Ω–¥–∞—Ä—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã** —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production

–°–∏—Å—Ç–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤–∞ –∫ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é:

- **EMQX mTLS** –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ
- **API –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã** –ø–æ–∫—Ä—ã–≤–∞—é—Ç –≤—Å–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã backend
- **Shared –±–∏–±–ª–∏–æ—Ç–µ–∫–∞** –∑–∞–º–µ–Ω—è–µ—Ç —É—Å—Ç–∞—Ä–µ–≤—à–∏–π iot-core
- **TypeScript –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏** –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –±—ã—Å—Ç—Ä–æ–π —Å–±–æ—Ä–∫–∏

**–†–∞–∑–º–µ—Ä –∫–æ–º–º–∏—Ç–∞**: 40+ —Ñ–∞–π–ª–æ–≤, ~15000 –∏–∑–º–µ–Ω–µ–Ω–∏–π
**–í—Ä–µ–º—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏**: –ø–æ–ª–Ω–∞—è —Ä–µ—Å—Ç—Ä—É–∫—Ç—É—Ä–∏–∑–∞—Ü–∏—è IoT Hub
**Impact**: –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –¥–ª—è production deployment
