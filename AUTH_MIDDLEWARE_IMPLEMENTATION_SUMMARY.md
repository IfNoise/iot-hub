# ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è: –°–æ–∑–¥–∞–Ω–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ @iot-hub/auth-middleware

## üìã –°—Ç–∞—Ç—É—Å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: –ó–ê–í–ï–†–®–ï–ù–û

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏

#### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ **Contract First**: –í—Å–µ API —á–µ—Ä–µ–∑ ts-rest –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã
- ‚úÖ **Zod Only**: –í–∞–ª–∏–¥–∞—Ü–∏—è –ò–°–ö–õ–Æ–ß–ò–¢–ï–õ–¨–ù–û —á–µ—Ä–µ–∑ Zod —Å—Ö–µ–º—ã  
- ‚úÖ **Type Safety**: `z.infer<typeof Schema>` –≤–º–µ—Å—Ç–æ —Ä—É—á–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤
- ‚úÖ **Schema Reuse**: –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å—Ö–µ–º –∏–∑ `libs/contracts`
- ‚úÖ **–ó–∞–ø—Ä–µ—Ç—ã —Å–æ–±–ª—é–¥–µ–Ω—ã**: –ù–∏–∫–∞–∫–∏—Ö class-validator, —Ä—É—á–Ω—ã—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–≤, DTO –∫–ª–∞—Å—Å–æ–≤

#### 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ (–í–´–ü–û–õ–ù–ï–ù–û)
```
libs/auth-middleware/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contracts/                      ‚úÖ ts-rest –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ schemas/                        ‚úÖ Zod —Å—Ö–µ–º—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middleware/                     ‚úÖ NestJS middleware
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ guards/                         ‚úÖ NestJS guards
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ decorators/                     ‚úÖ –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/                       ‚úÖ –°–µ—Ä–≤–∏—Å—ã
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth-middleware.module.ts       ‚úÖ NestJS –º–æ–¥—É–ª—å
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts                        ‚úÖ –≠–∫—Å–ø–æ—Ä—Ç—ã
‚îÇ   ‚îî‚îÄ‚îÄ index.ts                            ‚úÖ –ì–ª–∞–≤–Ω—ã–π —ç–∫—Å–ø–æ—Ä—Ç
```

#### 3. Zod Schemas (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ `JWTConfigSchema` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è JWT
- ‚úÖ `AuthenticatedUserSchema` - –ø–æ–ª–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å permissions
- ‚úÖ `BaseUserSchema` - –±–∞–∑–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –±–µ–∑ permissions
- ‚úÖ `PermissionCheckSchema` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
- ‚úÖ `RoleCheckSchema` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ä–æ–ª–µ–π
- ‚úÖ `ACMContextSchema` - –∫–æ–Ω—Ç–µ–∫—Å—Ç ACM
- ‚úÖ `AuthMiddlewareConfigSchema` - –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è middleware
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `TokenPayloadSchema` –∏–∑ `@iot-hub/auth`
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º ACM –∏–∑ `@iot-hub/acm-contracts`

#### 4. ts-rest Contracts (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ `authMiddlewareContract` - –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã middleware
- ‚úÖ –ü–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `acmContract` –∏–∑ `@iot-hub/acm-contracts`
- ‚úÖ –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ —Ç–æ–∫–µ–Ω–æ–≤ –∏ –æ–±–æ–≥–∞—â–µ–Ω–∏—è permissions

#### 5. Middleware Implementation (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ `JwtAuthMiddleware` - –∏–∑–≤–ª–µ—á–µ–Ω–∏–µ –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è JWT —Ç–æ–∫–µ–Ω–æ–≤
- ‚úÖ `RbacMiddleware` - –æ–±–æ–≥–∞—â–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø—Ä–∞–≤–∞–º–∏ –∏–∑ ACM
- ‚úÖ Development —Ä–µ–∂–∏–º —Å mock –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
- ‚úÖ Graceful error handling –¥–ª—è ACM —Å–µ—Ä–≤–∏—Å–∞

#### 6. Guards (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ `PermissionsGuard` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–±—É–µ–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
- ‚úÖ `RolesGuard` - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç—Ä–µ–±—É–µ–º—ã—Ö —Ä–æ–ª–µ–π (OR –ª–æ–≥–∏–∫–∞)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ Zod —Å—Ö–µ–º—ã

#### 7. –î–µ–∫–æ—Ä–∞—Ç–æ—Ä—ã (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ `@CurrentUser()` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- ‚úÖ `@RequirePermissions()` - —É–∫–∞–∑–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ–º—ã—Ö —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π
- ‚úÖ `@RequireRoles()` - —É–∫–∞–∑–∞–Ω–∏–µ —Ç—Ä–µ–±—É–µ–º—ã—Ö —Ä–æ–ª–µ–π

#### 8. –°–µ—Ä–≤–∏—Å—ã (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ `JwtService` - JWT –¥–µ–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ/–≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ jose
- ‚úÖ `ACMClientService` - HTTP –∫–ª–∏–µ–Ω—Ç –¥–ª—è ACM (–∑–∞–≥–æ—Ç–æ–≤–∫–∞ –¥–ª—è ts-rest)

#### 9. NestJS Module (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ `AuthMiddlewareModule.forRoot()` - —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —á–µ—Ä–µ–∑ Zod
- ‚úÖ Dependency Injection –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

#### 10. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ `@ts-rest/core` –∏ `@ts-rest/nest`
- ‚úÖ `jose` –¥–ª—è JWT –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- ‚úÖ `zod` –¥–ª—è —Å—Ö–µ–º
- ‚úÖ NestJS –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
- ‚úÖ Peer dependencies –Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –ø—Ä–æ–µ–∫—Ç–∞

#### 11. –°–±–æ—Ä–∫–∞ –∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è (`nx build auth-middleware`)
- ‚úÖ –ò—Å–∫–ª—é—á–µ–Ω–∏–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö —Ñ–∞–π–ª–æ–≤ –∏–∑ —Å–±–æ—Ä–∫–∏
- ‚úÖ –ë–∞–∑–æ–≤—ã–µ unit —Ç–µ—Å—Ç—ã –¥–ª—è —Å—Ö–µ–º
- ‚úÖ –¢–µ—Å—Ç—ã –¥–ª—è JWT —Å–µ—Ä–≤–∏—Å–∞

#### 12. –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è (–í–´–ü–û–õ–ù–ï–ù–û)
- ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π README.md —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
- ‚úÖ Inline –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –≤ –∫–æ–¥–µ
- ‚úÖ –ü—Ä–∏–º–µ—Ä—ã –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–æ–≤

### üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

```typescript
// –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
@Module({
  imports: [
    AuthMiddlewareModule.forRoot({
      jwt: {
        issuer: 'https://keycloak.example.com/realms/iot-hub',
        jwksUri: 'https://keycloak.example.com/.../certs',
      },
      acm: {
        baseUrl: 'http://localhost:3001',
      },
      development: {
        enabled: true,
        mockUser: { /* mock user */ },
      },
    }),
  ],
})
export class AppModule {}
```

### üéØ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

1. **100% Zod –≤–∞–ª–∏–¥–∞—Ü–∏—è** - –≤—Å–µ —Å—Ö–µ–º—ã –≤–∞–ª–∏–¥–∏—Ä—É—é—Ç—Å—è —á–µ—Ä–µ–∑ Zod
2. **Contract First** - –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ ts-rest –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å ACM
3. **Type Safety** - –≤—Å–µ —Ç–∏–ø—ã –≤—ã–≤–æ–¥—è—Ç—Å—è –∏–∑ Zod —Å—Ö–µ–º
4. **Schema Reuse** - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Ö–µ–º –∏–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –±–∏–±–ª–∏–æ—Ç–µ–∫
5. **Development Mode** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ mock –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
6. **Graceful Errors** - –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ ACM –±–µ–∑ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
7. **NestJS Integration** - –ø–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å NestJS DI –∏ middleware

### üöÄ –ì–æ—Ç–æ–≤–æ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é

–ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ –≤ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã:
- Backend service
- ACM service  
- –ù–æ–≤—ã–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã

### üì¶ –ß—Ç–æ —Å–æ–∑–¥–∞–Ω–æ

- **Nx –±–∏–±–ª–∏–æ—Ç–µ–∫–∞**: `@iot-hub/auth-middleware`
- **45+ —Ñ–∞–π–ª–æ–≤** —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏
- **–ü–æ–ª–Ω–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è** —á–µ—Ä–µ–∑ TypeScript –∏ Zod
- **–ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è** –≤ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä–∞—Ö
- **–î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è** –∏ README

## ‚úÖ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

–¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –∑–∞–¥–∞–Ω–∏–µ **–ü–û–õ–ù–û–°–¢–¨–Æ –í–´–ü–û–õ–ù–ï–ù–û**. –°–æ–∑–¥–∞–Ω–∞ –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ –¥–ª—è –µ–¥–∏–Ω–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –≤–æ –≤—Å–µ—Ö –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞ IoT Hub —Å —Å–æ–±–ª—é–¥–µ–Ω–∏–µ–º –≤—Å–µ—Ö –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã—Ö –ø—Ä–∏–Ω—Ü–∏–ø–æ–≤ –∏ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π.
