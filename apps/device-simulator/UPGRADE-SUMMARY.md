# Device Simulator - –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—é

## üìã –°–≤–æ–¥–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏–π

–°–∏–º—É–ª—è—Ç–æ—Ä IoT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –±—ã–ª —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π MQTT RPC –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã. –¢–µ–ø–µ—Ä—å –æ–Ω –ø–æ–ª–Ω–æ—Å—Ç—å—é —Å–æ–≤–º–µ—Å—Ç–∏–º —Å backend MQTT RPC API –∏ –º–æ–∂–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—ã –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏.

## ‚úÖ –ß—Ç–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ

### üîß –ù–æ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

1. **MqttDeviceService**: –°–µ—Ä–≤–∏—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ MQTT RPC –∫–æ–º–∞–Ω–¥
2. **MqttDeviceModule**: –ú–æ–¥—É–ª—å –¥–ª—è MQTT —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
3. **DeviceDataProvider**: –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
4. **–û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ MQTT –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

### üöÄ –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

1. **MQTT RPC Integration**: –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MQTT RPC –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –ø—Ä–æ–µ–∫—Ç–∞
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö 8 RPC –º–µ—Ç–æ–¥–æ–≤ –∏–∑ backend
3. **Real-time –æ—Ç–≤–µ—Ç—ã**: –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –æ—Ç–≤–µ—Ç –Ω–∞ –∫–æ–º–∞–Ω–¥—ã
4. **–°—Ç–∞—Ç—É—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### üì° –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ RPC –º–µ—Ç–æ–¥—ã

| –ú–µ—Ç–æ–¥                     | –û–ø–∏—Å–∞–Ω–∏–µ                      | –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ |
| ------------------------- | ----------------------------- | ----------- |
| `getDeviceState`          | –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ | ‚úÖ          |
| `getSensors`              | –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–Ω—Å–æ—Ä–æ–≤      | ‚úÖ          |
| `reboot`                  | –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ      | ‚úÖ          |
| `updateDiscreteTimer`     | –û–±–Ω–æ–≤–∏—Ç—å –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã–π —Ç–∞–π–º–µ—Ä    | ‚úÖ          |
| `updateAnalogTimer`       | –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–æ–≥–æ–≤—ã–π —Ç–∞–π–º–µ—Ä    | ‚úÖ          |
| `updateDiscreteRegulator` | –û–±–Ω–æ–≤–∏—Ç—å –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ–≥—É–ª—è—Ç–æ—Ä | ‚úÖ          |
| `updateAnalogRegulator`   | –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–æ–≥–æ–≤—ã–π —Ä–µ–≥—É–ª—è—Ç–æ—Ä | ‚úÖ          |
| `updateIrrigator`         | –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Ä—Ä–∏–≥–∞—Ç–æ—Ä–∞ | ‚úÖ          |

## üõ†Ô∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

### –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏

```typescript
DeviceSimulatorService {
  // –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
  + implements DeviceDataProvider
  + —É–ø—Ä–∞–≤–ª—è–µ—Ç MQTT —á–µ—Ä–µ–∑ dependency injection
  + –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç –¥–∞–Ω–Ω—ã–µ –¥–ª—è RPC –æ—Ç–≤–µ—Ç–æ–≤
}

MqttDeviceService {
  // MQTT RPC —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
  + –æ–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ö–æ–¥—è—â–∏—Ö –∫–æ–º–∞–Ω–¥
  + –æ—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç–≤–µ—Ç–æ–≤
  + —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
}
```

### –ò–∑–±–µ–∂–∞–Ω–∏–µ —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏—Ö –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –ø–∞—Ç—Ç–µ—Ä–Ω Provider/Consumer
- `DeviceSimulatorService` —Ä–µ–∞–ª–∏–∑—É–µ—Ç `DeviceDataProvider`
- `MqttDeviceService` –ø–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

## üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

### –ù–æ–≤—ã–µ —Ñ–∞–π–ª—ã

- `/src/mqtt/mqtt-device.service.ts` - MQTT RPC —Å–µ—Ä–≤–∏—Å
- `/src/mqtt/mqtt-device.module.ts` - MQTT –º–æ–¥—É–ª—å
- `/README-UPDATED.md` - –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
- `/test-device-simulator.sh` - –¢–µ—Å—Ç–æ–≤—ã–π —Å–∫—Ä–∏–ø—Ç

### –ò–∑–º–µ–Ω–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã

- `/src/device-simulator/device-simulator.service.ts` - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MQTT
- `/src/device-simulator/device-simulator.module.ts` - –ò–º–ø–æ—Ä—Ç MQTT –º–æ–¥—É–ª—è
- `/src/device-simulator/device-simulator.controller.ts` - –ù–æ–≤—ã–µ endpoints
- `/src/main.ts` - –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ª–æ–≥–∏ –∑–∞–ø—É—Å–∫–∞

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç–µ—Å—Ç

```bash
./test-device-simulator.sh
```

### –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

1. **–ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞**:

```bash
curl -X POST http://localhost:3001/api/simulator/configure \
  -H "Content-Type: application/json" \
  -d '{
    "deviceId": "test-device",
    "model": "IoT-Simulator-v2",
    "firmwareVersion": "2.0.0",
    "mqtt": {
      "brokerUrl": "mqtt://localhost:1883",
      "userId": "test-user"
    }
  }'
```

2. **–ü—Ä–æ–≤–µ—Ä–∫–∞ MQTT —Å—Ç–∞—Ç—É—Å–∞**:

```bash
curl http://localhost:3001/api/simulator/mqtt/status
```

3. **–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ RPC –∫–æ–º–∞–Ω–¥—ã** (—á–µ—Ä–µ–∑ backend):

```bash
curl -X POST http://localhost:3000/api/mqtt/device/command \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "test-user",
    "deviceId": "test-device",
    "method": "getSensors"
  }'
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

‚úÖ **–°–±–æ—Ä–∫–∞**: –£—Å–ø–µ—à–Ω–æ —Å–æ–±–∏—Ä–∞–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫  
‚úÖ **–ó–∞–ø—É—Å–∫**: –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –Ω–∞ –ø–æ—Ä—Ç—É 3001  
‚úÖ **MQTT**: –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ –±—Ä–æ–∫–µ—Ä—É –Ω–∞ localhost:1883  
‚úÖ **API**: –í—Å–µ endpoints —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ  
‚úÖ **RPC**: –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –æ—Ç backend  
‚úÖ **–°–µ–Ω—Å–æ—Ä—ã**: –ì–µ–Ω–µ—Ä–∏—Ä—É—é—Ç —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ  
‚úÖ **–ö—Ä–∏–ø—Ç–æ—á–∏–ø**: –°–∏–º—É–ª—è—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

## üîÑ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —ç–∫–æ—Å–∏—Å—Ç–µ–º–æ–π

### –° Backend MQTT RPC API

- –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å `/api/mqtt/device/command`
- –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö RPC –º–µ—Ç–æ–¥–æ–≤
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤

### –° Shared Library

- –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `MqttRpcClient` –∏–∑ `@iot-hub/shared`
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å RPC —Ç–∏–ø–∞–º–∏ –∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏

### –° Contracts

- –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –º–µ—Ç–æ–¥—ã –∏–∑ `mqttContract`
- –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å—Ö–µ–º—ã –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤

## üöÄ –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production

–°–∏–º—É–ª—è—Ç–æ—Ä –≥–æ—Ç–æ–≤ –¥–ª—è:

- ‚úÖ –î–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª–Ω–æ–≥–æ IoT —Ñ–ª–æ—É
- ‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è backend MQTT RPC API
- ‚úÖ –†–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –∏ –æ—Ç–ª–∞–¥–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–æ–Ω–Ω–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è

## üîÆ –í–æ–∑–º–æ–∂–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è

1. **–ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
2. **Multi-device**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
3. **WebSocket UI**: Real-time –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
4. **Advanced simulation**: –ë–æ–ª–µ–µ —Å–ª–æ–∂–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏
5. **Metrics**: –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞

---

**–°–∏–º—É–ª—è—Ç–æ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é! üéâ**
