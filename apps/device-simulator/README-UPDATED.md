# Device Simulator - –û–±–Ω–æ–≤–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è

## üöÄ –û–±–∑–æ—Ä

–°–∏–º—É–ª—è—Ç–æ—Ä IoT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø–æ–ª–Ω—É—é –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å MQTT RPC –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π –ø—Ä–æ–µ–∫—Ç–∞. –í–∫–ª—é—á–∞–µ—Ç:

- ‚úÖ –ò–º–∏—Ç–∞—Ü–∏—é –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ —á–∏–ø–∞
- ‚úÖ MQTT RPC –∫–ª–∏–µ–Ω—Ç –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∫–æ–º–∞–Ω–¥ –æ—Ç backend
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫—É –≤—Å–µ—Ö RPC –º–µ—Ç–æ–¥–æ–≤ (getDeviceState, getSensors, reboot –∏ –¥—Ä.)
- ‚úÖ –ü–æ–ª–Ω—ã–π —Ñ–ª–æ—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- ‚úÖ –°–∏–º—É–ª—è—Ü–∏—é —Å–µ–Ω—Å–æ—Ä–æ–≤ —Å —Ä–µ–∞–ª–∏—Å—Ç–∏—á–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

## üîÑ –ò–∑–º–µ–Ω–µ–Ω–∏—è

### –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å

1. **MQTT RPC Integration**: –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å MQTT RPC –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–æ–π
2. **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–æ–º–∞–Ω–¥**: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö RPC –º–µ—Ç–æ–¥–æ–≤ –∏–∑ backend
3. **–£–ª—É—á—à–µ–Ω–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è**: –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ MQTT –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤
4. **–°—Ç–∞—Ç—É—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥**: –≠–Ω–¥–ø–æ–∏–Ω—Ç—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ MQTT

### –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –º–æ–¥—É–ª–∏

- `MqttDeviceService`: –ù–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ MQTT RPC –∫–æ–º–∞–Ω–¥
- `MqttDeviceModule`: –ú–æ–¥—É–ª—å –¥–ª—è MQTT —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏
- `DeviceSimulatorService`: –û–±–Ω–æ–≤–ª–µ–Ω –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å MQTT
- `DeviceSimulatorController`: –î–æ–±–∞–≤–ª–µ–Ω—ã –Ω–æ–≤—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

## üì° MQTT RPC Methods

–°–∏–º—É–ª—è—Ç–æ—Ä –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç —Å–ª–µ–¥—É—é—â–∏–µ RPC –º–µ—Ç–æ–¥—ã:

| –ú–µ—Ç–æ–¥                     | –û–ø–∏—Å–∞–Ω–∏–µ                      | –ü–∞—Ä–∞–º–µ—Ç—Ä—ã                                      |
| ------------------------- | ----------------------------- | ---------------------------------------------- |
| `getDeviceState`          | –ü–æ–ª—É—á–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ | `{}`                                           |
| `getSensors`              | –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–Ω—Å–æ—Ä–æ–≤      | `{}`                                           |
| `reboot`                  | –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ      | `{}`                                           |
| `updateDiscreteTimer`     | –û–±–Ω–æ–≤–∏—Ç—å –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã–π —Ç–∞–π–º–µ—Ä    | `{ id, enabled, schedule, duration, channel }` |
| `updateAnalogTimer`       | –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–æ–≥–æ–≤—ã–π —Ç–∞–π–º–µ—Ä    | `{ id, enabled, schedule, duration, channel }` |
| `updateDiscreteRegulator` | –û–±–Ω–æ–≤–∏—Ç—å –¥–∏—Å–∫—Ä–µ—Ç–Ω—ã–π —Ä–µ–≥—É–ª—è—Ç–æ—Ä | `{ id, enabled, threshold, hysteresis }`       |
| `updateAnalogRegulator`   | –û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–æ–≥–æ–≤—ã–π —Ä–µ–≥—É–ª—è—Ç–æ—Ä | `{ id, enabled, setpoint, kp, ki, kd }`        |
| `updateIrrigator`         | –û–±–Ω–æ–≤–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏—Ä—Ä–∏–≥–∞—Ç–æ—Ä–∞ | `{ id, enabled, schedule, duration, zones }`   |

## üõ†Ô∏è API Endpoints

### –û—Å–Ω–æ–≤–Ω—ã–µ —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã

- `POST /api/simulator/configure` - –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `GET /api/simulator/status` - –ü–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- `GET /api/simulator/sensors` - –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —Å–µ–Ω—Å–æ—Ä–æ–≤
- `GET /api/simulator/mqtt/status` - –°—Ç–∞—Ç—É—Å MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏

```json
{
  "deviceId": "device-001",
  "model": "IoT-Simulator-v2",
  "firmwareVersion": "2.0.0",
  "backendUrl": "http://localhost:3000",
  "autoRegister": true,
  "mqtt": {
    "brokerUrl": "mqtt://localhost:1883",
    "userId": "user-123",
    "token": "jwt-token-here",
    "qos": 1
  }
}
```

## üöÄ –ó–∞–ø—É—Å–∫

### –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

```bash
# –ó–∞–ø—É—Å–∫ —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
nx serve device-simulator

# –ò–ª–∏
npm run start:dev device-simulator
```

### Production

```bash
# –°–±–æ—Ä–∫–∞
nx build device-simulator

# –ó–∞–ø—É—Å–∫
nx serve device-simulator --configuration=production
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

```bash
curl -X POST http://localhost:3001/api/simulator/configure \
  -H "Content-Type: application/json" \
  -d '{
    "deviceId": "test-device-001",
    "model": "IoT-Simulator-v2",
    "firmwareVersion": "2.0.0",
    "backendUrl": "http://localhost:3000",
    "autoRegister": true,
    "mqtt": {
      "brokerUrl": "mqtt://localhost:1883",
      "userId": "test-user",
      "qos": 1
    }
  }'
```

### –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞

```bash
# –û–±—â–∏–π —Å—Ç–∞—Ç—É—Å
curl http://localhost:3001/api/simulator/status

# –°—Ç–∞—Ç—É—Å MQTT
curl http://localhost:3001/api/simulator/mqtt/status

# –î–∞–Ω–Ω—ã–µ —Å–µ–Ω—Å–æ—Ä–æ–≤
curl http://localhost:3001/api/simulator/sensors
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ RPC –∫–æ–º–∞–Ω–¥ —á–µ—Ä–µ–∑ backend

```bash
# –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥—ã —á–µ—Ä–µ–∑ backend MQTT RPC API
curl -X POST http://localhost:3000/api/mqtt/device/command \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "test-user",
    "deviceId": "test-device-001",
    "method": "getDeviceState",
    "timeout": 5000
  }'
```

## üîß –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

```text
DeviceSimulator
‚îú‚îÄ‚îÄ main.ts                      # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ app.module.ts           # –ì–ª–∞–≤–Ω—ã–π –º–æ–¥—É–ª—å
‚îÇ   ‚îî‚îÄ‚îÄ app.controller.ts       # –ë–∞–∑–æ–≤—ã–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
‚îú‚îÄ‚îÄ device-simulator/           # –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ —Å–∏–º—É–ª—è—Ç–æ—Ä–∞
‚îÇ   ‚îú‚îÄ‚îÄ device-simulator.module.ts
‚îÇ   ‚îú‚îÄ‚îÄ device-simulator.service.ts
‚îÇ   ‚îî‚îÄ‚îÄ device-simulator.controller.ts
‚îú‚îÄ‚îÄ mqtt/                       # MQTT RPC —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å
‚îÇ   ‚îú‚îÄ‚îÄ mqtt-device.module.ts
‚îÇ   ‚îî‚îÄ‚îÄ mqtt-device.service.ts  # –û–±—Ä–∞–±–æ—Ç–∫–∞ RPC –∫–æ–º–∞–Ω–¥
‚îî‚îÄ‚îÄ crypto-chip/               # –°–∏–º—É–ª—è—Ü–∏—è –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ —á–∏–ø–∞
    ‚îú‚îÄ‚îÄ crypto-chip.module.ts
    ‚îî‚îÄ‚îÄ crypto-chip.service.ts
```

## üîó –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

–°–∏–º—É–ª—è—Ç–æ—Ä –∏–Ω—Ç–µ–≥—Ä–∏—Ä—É–µ—Ç—Å—è —Å:

- **Backend MQTT RPC Service**: –ü–æ–ª—É—á–∞–µ—Ç –∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã
- **Shared Library**: –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –æ–±—â–∏–π MQTT RPC –∫–ª–∏–µ–Ω—Ç
- **Contracts**: –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –≤—Å–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã MQTT RPC
- **Crypto Module**: –ò–º–∏—Ç–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–≥–æ —á–∏–ø–∞

## üìä –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

–°–∏–º—É–ª—è—Ç–æ—Ä –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç:

- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- –°—Ç–∞—Ç—É—Å MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- –î–∞–Ω–Ω—ã–µ —Å–µ–Ω—Å–æ—Ä–æ–≤ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏
- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—Ä–∏–ø—Ç–æ–≥—Ä–∞—Ñ–∏—á–µ—Å–∫–æ–º —á–∏–ø–µ

## üêõ –û—Ç–ª–∞–¥–∫–∞

### –ü—Ä–æ–±–ª–µ–º—ã —Å MQTT

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å MQTT
curl http://localhost:3001/api/simulator/mqtt/status

# –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏
docker logs device-simulator
```

### –ü—Ä–æ–±–ª–µ–º—ã —Å –∫–æ–º–∞–Ω–¥–∞–º–∏

1. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ MQTT –±—Ä–æ–∫–µ—Ä –∑–∞–ø—É—â–µ–Ω
2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —á—Ç–æ backend MQTT RPC —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç
3. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É —Ç–æ–ø–∏–∫—É
4. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–∏–º—É–ª—è—Ç–æ—Ä–∞ –Ω–∞ –æ—à–∏–±–∫–∏

## üîÑ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. –î–æ–±–∞–≤–∏—Ç—å –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω—É—é —Å–∏–º—É–ª—è—Ü–∏—é —É—Å—Ç—Ä–æ–π—Å—Ç–≤
2. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
3. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç—Ä–∏–∫–∏ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
4. –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –≤ –æ–¥–Ω–æ–º —Å–∏–º—É–ª—è—Ç–æ—Ä–µ
5. WebSocket –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
