# Comercial Grow Device and cloud system.

## IoT-архитектура с безопасностью уровня производства

### Цель проекта

Создание платформы управления IoT-устройствами , которая:

- Поддерживает безопасную mTLS-коммуникацию через EMQX (MQTT v5)
- Обеспечивает управление пользователями через Keycloak и OAuth2 Proxy
- Поддерживает привязку устройств к аккаунтам через QR-коды
- Использует современный backend (NestJS + PostgreSQL) и frontend Next.js
- Реализует безопасное хранение ключей и сертификатов на устройствах с использованием крипточипов (ATECC608A)
- Имеет покрытие тестами, CI/CD и инфраструктуру для масштабирования

---

### Компоненты системы

### 1. Устройство

- MCU: ESP32 or STM32
- Secure Element: ATECC608A
- Генерация приватного ключа в чипе
- Генерация CSR и передача на сервер для подписи
- Хранение сертификата в устройстве
- QR-код с данными `{ deviceId, fingerprint, publicKey }`
- Подключение к EMQX по mTLS
- Отправка данных в формате JSON через MQTT

### 2. Производство устройства

<!-- - Backend генерирует Device ID -->

- Подпись CSR своим CA
- Генерация QR-кода
- Добавление устройства в базу данных со статусом "unbound"

### 3. Привязка устройства

- Пользователь регистрируется и аутентифицируется
- Пользователь сканирует QR-код
- Отправка данных на backend
- Backend проверяет `deviceId` и `fingerprint`,
- Если ок — устройство привязывается к пользователю endpoint `/devices/bind`
- Устройство получает команду на привязку и отправляет подтверждение
- Обновление статуса устройства в базе данных на "bound"
- Отправка уведомления пользователю о привязке

### 4. MQTT-брокер (EMQX)

- TLS + mTLS (сервер требует клиентский сертификат)
- Проверка по Common Name (`deviceId`)
- Аутентификация по клиентскому сертификату
- Авторизация по user/password (user — deviceId, password — fingerprint)

### 5. Backend (NestJS)

- PostgreSQL (устройства, пользователи, связи, логи)
- **Enterprise support**: Организации, группы, иерархическая структура
- Модули:
- `DevicesModule` (управление устройствами)
- `UsersModule` (управление пользователями)
- `OrganizationsModule` (управление организациями и группами)
- `AuthModule` (аутентификация и авторизация)
- `MqttModule` (интеграция с EMQX)
- `ConfigModule` (конфигурация и окружение)
- `DatabaseModule` (подключение к PostgreSQL)
- `CryptoModule` (работа с криптографией и сертификатами)
- Zod ,Nestjs-zod для DTO/валидации
- Юнит-тесты через Jest
- Логгирование -Pino
- Аудит, защита от CSRF/CORS

### 5.1. Enterprise архитектура

**Иерархическая структура:**

- **Индивидуальные пользователи** (обратная совместимость)
- **Организации** с multiple users
- **Группы** внутри организаций (поддержка вложенности)
- **Устройства** могут принадлежать:
  - Индивидуальному пользователю (`ownerType: 'user'`)
  - Группе (`ownerType: 'group'`)

**Минимальные изменения:**

- Добавлены опциональные поля в User и Device схемы
- MQTT топики остаются неизменными (`deviceId/category/direction`)
- Полная обратная совместимость с существующими API
- Разрешения наследуются по иерархии (организация → группа → устройство)

### 6. Пользователи и авторизация

- Keycloak (управление пользователями, группы, роли)
- OAuth2 Proxy для интеграции с UI/API
- Авторизация через JWT (access/refresh)
- Защита админских интерфейсов (RBAC)

### 7. CI/CD и инфраструктура

- GitHub Actions (lint, test, build, docker push)
- Docker Compose (backend, frontend, emqx, keycloak)
- Kubernetes (для продакшена)
- Helm Charts (упрощение деплоя)
- Dev и prod конфиги (через dotenv и секреты)
- OTA обновления через HTTPS

### 8. Безопасность

- mTLS (client certs + broker verification)
- Fingerprint на момент привязки
- Отзыв сертификатов (через CRL или OCSP)
- Проверка ACL
- Минимизация attack surface
- Разделение прав доступа к API и MQTT

---

### Этапы реализации

1. Проектирование БД устройств и пользователей
2. Создание симулятора устройства (ESP32/STM32)
3. Настройка CA и генерация/подпись сертификатов
4. Подключение крипточипа и генерация ключа
5. Реализация API привязки устройств
6. Конфигурация EMQX для mTLS и ACL
7. Интеграция Keycloak и OAuth2 Proxy
8. Web-интерфейс для пользователей (привязка, мониторинг)
9. Обмен сообщениями MQTT/WebSocket
10. OTA и обновления прошивки
11. Тестирование, CI/CD, деплой

---
