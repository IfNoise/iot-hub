# MQTT RPC Module - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è

## –û–±–∑–æ—Ä —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞

–°–æ–∑–¥–∞–Ω –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –º–æ–¥—É–ª—å –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ RPC –∫–æ–º–∞–Ω–¥ IoT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º —á–µ—Ä–µ–∑ MQTT –±—Ä–æ–∫–µ—Ä —Å REST API –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–æ–º.

## –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞

```
app/backend/src/mqtt/
‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îî‚îÄ‚îÄ device-command.dto.ts      # DTO —Å Zod –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îî‚îÄ‚îÄ mqtt-config.schema.ts      # –°—Ö–µ–º–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ MQTT
‚îú‚îÄ‚îÄ mqtt-rpc.service.ts            # –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–∏—Å MQTT RPC
‚îú‚îÄ‚îÄ mqtt-rpc.controller.ts         # REST –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä
‚îî‚îÄ‚îÄ mqtt.module.ts                 # NestJS –º–æ–¥—É–ª—å

docs/
‚îî‚îÄ‚îÄ MQTT_RPC_API.md               # –ü–æ–ª–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è API

test-mqtt-rpc.js                  # –°–∫—Ä–∏–ø—Ç –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
```

## –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

### 1. MqttRpcService

- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å ConfigService –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫ MQTT
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ Pino –ª–æ–≥–≥–µ—Ä–∞ –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MQTT –±—Ä–æ–∫–µ—Ä—É
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∂–∏–∑–Ω–µ–Ω–Ω—ã–º —Ü–∏–∫–ª–æ–º (OnModuleInit, OnModuleDestroy)
- ‚úÖ –û—Ç–ø—Ä–∞–≤–∫–∞ –∫–æ–º–∞–Ω–¥ —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º –æ—Ç–≤–µ—Ç–∞ –∏ –±–µ–∑
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤ –∏ –æ—à–∏–±–æ–∫
- ‚úÖ –°—Ç–∞—Ç—É—Å –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

### 2. MqttRpcController

- ‚úÖ REST API endpoints:
  - `POST /api/mqtt/device/command` - –∫–æ–º–∞–Ω–¥–∞ —Å –æ—Ç–≤–µ—Ç–æ–º
  - `POST /api/mqtt/device/command/no-response` - –∫–æ–º–∞–Ω–¥–∞ –±–µ–∑ –æ—Ç–≤–µ—Ç–∞
  - `POST /api/mqtt/status` - —Å—Ç–∞—Ç—É—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- ‚úÖ Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ HTTP –æ—à–∏–±–æ–∫ (400, 408, 503, 500)
- ‚úÖ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤ –æ—Ç–≤–µ—Ç–∞—Ö (–≤—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è, –≤—Ä–µ–º–µ–Ω–Ω—ã–µ –º–µ—Ç–∫–∏)

### 3. DeviceCommandDto

- ‚úÖ Zod —Å—Ö–µ–º—ã –¥–ª—è –≤—Å–µ—Ö –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã—Ö RPC –º–µ—Ç–æ–¥–æ–≤
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–º–∞–Ω–¥
- ‚úÖ –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω—ã–µ DTO –∫–ª–∞—Å—Å—ã —Å nestjs-zod
- ‚úÖ Discriminated union –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ç–∏–ø–æ–≤ –∫–æ–º–∞–Ω–¥

### 4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

- ‚úÖ –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –≤—Å–µ—Ö MQTT –Ω–∞—Å—Ç—Ä–æ–µ–∫
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π ConfigService
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ MQTT Will (Last Will and Testament)
- ‚úÖ –ù–∞—Å—Ç—Ä–æ–π–∫–∏ QoS, keepalive, —Ç–∞–π–º–∞—É—Ç—ã

## –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ RPC –º–µ—Ç–æ–¥—ã

- ‚úÖ `getDeviceState` - –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- ‚úÖ `getSensors` - –ø–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Å–µ–Ω—Å–æ—Ä–æ–≤
- ‚úÖ `reboot` - –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
- ‚úÖ `updateDiscreteTimer` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏—Å–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞
- ‚úÖ `updateAnalogTimer` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ —Ç–∞–π–º–µ—Ä–∞
- ‚úÖ `updateDiscreteRegulator` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∏—Å–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞
- ‚úÖ `updateAnalogRegulator` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–Ω–∞–ª–æ–≥–æ–≤–æ–≥–æ —Ä–µ–≥—É–ª—è—Ç–æ—Ä–∞
- ‚úÖ `updateIrrigator` - –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–∫ –∏—Ä—Ä–∏–≥–∞—Ç–æ—Ä–∞

## –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏

### –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—è

- üîí Zod –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤—Å–µ—Ö –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- üîí –¢–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å –Ω–∞ —É—Ä–æ–≤–Ω–µ TypeScript
- üîí –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π —Å–∏—Å—Ç–µ–º–æ–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ Keycloak

### –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

- üìù –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å Pino
- üìù –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω—ã–µ –ª–æ–≥–∏ —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏ (userId, deviceId, method)
- üìù –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∫–æ–º–∞–Ω–¥
- üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—à–∏–±–æ–∫ –∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–π

### –ù–∞–¥–µ–∂–Ω–æ—Å—Ç—å

- üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ MQTT –±—Ä–æ–∫–µ—Ä—É
- üîÑ –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–∞–π–º–∞—É—Ç–æ–≤ –∫–æ–º–∞–Ω–¥
- üîÑ Graceful shutdown –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞ –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π –∫–æ–º–∞–Ω–¥

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- üìä Endpoint –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ MQTT –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- üìä –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –≤ –æ—Ç–≤–µ—Ç–∞—Ö
- üìä –î–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π

## –ü—Ä–∏–º–µ—Ä—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è

### –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞

```bash
curl -X POST http://localhost:3000/api/mqtt/device/command \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "user123",
    "deviceId": "device456",
    "method": "getDeviceState",
    "timeout": 5000
  }'
```

### –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞

```bash
curl -X POST http://localhost:3000/api/mqtt/device/command \
  -H "Content-Type: application/json" \
  -d '{
    "userId": "user123",
    "deviceId": "device456",
    "method": "updateDiscreteTimer",
    "params": {
      "id": 1,
      "enabled": true,
      "schedule": "0 8 * * *",
      "duration": 300,
      "channel": 1
    }
  }'
```

### –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞
node test-mqtt-rpc.js

# –° –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏
node test-mqtt-rpc.js --host localhost --port 3000 --user test-user --device test-device
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å iot-core

- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç `MqttRpcClient` –∏–∑ –ø–∞–∫–µ—Ç–∞ iot-core
- ‚úÖ –ò–º–ø–æ—Ä—Ç–∏—Ä—É–µ—Ç RPC —Ç–∏–ø—ã –∏–∑ iot-core
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç —Å—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –∏–∑ iot-core
- ‚úÖ –ü–æ–ª–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å RPC –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–∫—Ä—É–∂–µ–Ω–∏—è

```env
# MQTT –±—Ä–æ–∫–µ—Ä
MQTT_HOST=localhost
MQTT_PORT=1883
MQTT_USERNAME=mqtt_user
MQTT_PASSWORD=mqtt_password
MQTT_CLIENT_ID=iot-hub-backend

# MQTT –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
MQTT_KEEPALIVE=60
MQTT_CLEAN_SESSION=true
MQTT_RECONNECT_PERIOD=2000
MQTT_CONNECT_TIMEOUT=30000
MQTT_QOS=1
MQTT_RETAIN=false

# MQTT Will
MQTT_WILL_TOPIC=will/backend
MQTT_WILL_PAYLOAD=backend-disconnected
MQTT_WILL_QOS=0
MQTT_WILL_RETAIN=false
MQTT_MAX_RECONNECT_ATTEMPTS=10
```

## –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ MQTT –±—Ä–æ–∫–µ—Ä–∞ (Mosquitto/EMQX)
2. üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
3. üìà –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫ –∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
4. üîê –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSL/TLS –¥–ª—è MQTT
5. üì¶ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ –≤ production –æ–∫—Ä—É–∂–µ–Ω–∏–∏

## –†–µ–∑—É–ª—å—Ç–∞—Ç

–°–æ–∑–¥–∞–Ω –ø–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π MQTT RPC –º–æ–¥—É–ª—å —Å:

- ‚úÖ REST API –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–æ–º–∞–Ω–¥ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º
- ‚úÖ –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π —Å ConfigService –∏ Pino –ª–æ–≥–≥–µ—Ä–æ–º
- ‚úÖ Zod –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π –∏ —Ç–∏–ø–æ–±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å—é
- ‚úÖ Swagger –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π
- ‚úÖ –¢–µ—Å—Ç–æ–≤—ã–º —Å–∫—Ä–∏–ø—Ç–æ–º
- ‚úÖ –ü–æ–ª–Ω–æ–π –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π

–ú–æ–¥—É–ª—å –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é –≤ production –æ–∫—Ä—É–∂–µ–Ω–∏–∏! üöÄ
