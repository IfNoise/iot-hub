# –ò—Ç–µ—Ä–∞—Ü–∏—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–æ–≤ - –†–µ–∑—é–º–µ

## –ò—Ç–µ—Ä–∞—Ü–∏—è 1: UserManagement –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:

#### 1. –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ –∏ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π —Å—Ç–µ–∫

- **NX Workspace**: –ú–æ–Ω–æ—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π —Å —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–º —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏
- **Drizzle ORM**: –°–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è TypeScript-first ORM —Å PostgreSQL
- **Existing Contracts**: –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤—ã—Ö –∫–æ–Ω—Ç—Ä–∞–∫—Ç–æ–≤ –∏–∑ `@iot-hub/contracts/users`
- **Keycloak Integration**: –ü–æ–ª–Ω–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å —Å–∏—Å—Ç–µ–º–æ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- **Kafka Events**: –°–∏—Å—Ç–µ–º–∞ —Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

#### 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–∞

```
apps/user-management/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.controller.ts      # –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä —Å–µ—Ä–≤–∏—Å–∞
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ app.service.ts         # –°–µ—Ä–≤–∏—Å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ app.module.ts          # –ì–ª–∞–≤–Ω—ã–π –º–æ–¥—É–ª—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îÇ   ‚îú‚îÄ‚îÄ user/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.controller.ts     # REST API –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ user.service.ts        # –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ user.module.ts         # –ú–æ–¥—É–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
‚îÇ   ‚îú‚îÄ‚îÄ infrastructure/
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ database/
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ database.module.ts  # –ú–æ–¥—É–ª—å –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö
‚îÇ   ‚îÇ       ‚îú‚îÄ‚îÄ database.service.ts # –°–µ—Ä–≤–∏—Å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ –ë–î
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ schema.ts          # –ü–æ–ª–Ω–∞—è Enterprise —Å—Ö–µ–º–∞ –ë–î
‚îÇ   ‚îî‚îÄ‚îÄ main.ts                    # –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
‚îú‚îÄ‚îÄ migrations/
‚îÇ   ‚îî‚îÄ‚îÄ 0000_lively_captain_stacy.sql  # –ì–æ—Ç–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è –ë–î
‚îî‚îÄ‚îÄ drizzle.config.ts              # –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è Drizzle ORM
```

#### 3. Enterprise Database Schema

- **users**: –û—Å–Ω–æ–≤–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π Keycloak
- **organizations**: –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ —Å –ø–ª–∞–Ω–∞–º–∏ –∏ –ª–∏–º–∏—Ç–∞–º–∏
- **groups**: –ì—Ä—É–ø–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **userGroups**: –°–≤—è–∑–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –≥—Ä—É–ø–ø
- **billingEvents**: –°–æ–±—ã—Ç–∏—è –±–∏–ª–ª–∏–Ω–≥–∞
- **dataUsage**: –£—á–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö

**–ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:**

- Soft delete –¥–ª—è –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü
- –ü–æ–ª–Ω–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
- Billing –∏ usage tracking
- Enterprise –ø–ª–∞–Ω—ã (free, pro, enterprise)
- 7 —Ä–æ–ª–µ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (user, admin, owner, support, billing, dev, viewer)

#### 4. UserService Implementation

- **CRUD –æ–ø–µ—Ä–∞—Ü–∏–∏**: –ü–æ–ª–Ω—ã–π –Ω–∞–±–æ—Ä –æ–ø–µ—Ä–∞—Ü–∏–π —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
- **Keycloak Sync**: –î–≤—É—Å—Ç–æ—Ä–æ–Ω–Ω—è—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **Organization Management**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è–º–∏ –∏ –ª–∏–º–∏—Ç–∞–º–∏
- **Event Publishing**: Kafka —Å–æ–±—ã—Ç–∏—è –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- **Error Handling**: –ö–æ–º–ø–ª–µ–∫—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- **Validation**: –í–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—ã

#### 5. API Endpoints

```typescript
GET /users              # –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π
GET /users/:id          # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID
POST /users             # –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
PATCH /users/:id        # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
DELETE /users/:id       # –£–¥–∞–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (soft delete)
```

#### 6. Event-Driven Architecture

```typescript
// Kafka Events
-UserCreated -
  UserUpdated -
  UserDeleted -
  UserOrganizationAdded -
  UserGroupAssigned;
```

### üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–µ—à–µ–Ω–∏—è:

#### 1. NX Workspace —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ

- –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –≤ –∫–æ—Ä–Ω–µ–≤–æ–º `package.json`
- –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö `project.json` —Ñ–∞–π–ª–æ–≤
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ NX –∞–ª–∏–∞—Å–æ–≤ –º–æ–¥—É–ª–µ–π
- –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è TypeScript paths

#### 2. Contract-First –ø–æ–¥—Ö–æ–¥

- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥–æ—Ç–æ–≤—ã—Ö —Å—Ö–µ–º –∏–∑ `@iot-hub/contracts/users`
- CreateUserSchema –∏ UpdateUserSchema –≤–∞–ª–∏–¥–∞—Ü–∏—è
- –¢–∏–ø–∏–∑–∞—Ü–∏—è —á–µ—Ä–µ–∑ –≥–æ—Ç–æ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã
- –°–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å Enterprise —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è–º–∏

#### 3. Database Management

- Drizzle ORM —Å PostgreSQL
- –ì–æ—Ç–æ–≤–∞—è –º–∏–≥—Ä–∞—Ü–∏—è `0000_lively_captain_stacy.sql`
- Enterprise schema —Å 6 —Ç–∞–±–ª–∏—Ü–∞–º–∏
- –ü—Ä–∞–≤–∏–ª—å–Ω—ã–µ –≤–Ω–µ—à–Ω–∏–µ –∫–ª—é—á–∏ –∏ –∏–Ω–¥–µ–∫—Å—ã

### ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞—á–µ—Å—Ç–≤–∞:

#### 1. Build System

```bash
npx nx build user-management  # ‚úÖ –£—Å–ø–µ—à–Ω–æ
```

#### 2. Code Quality

```bash
Codacy CLI Analysis:
- Semgrep OSS: ‚úÖ –ù–µ—Ç –ø—Ä–æ–±–ª–µ–º
- Trivy Scanner: ‚úÖ –ù–µ—Ç —É—è–∑–≤–∏–º–æ—Å—Ç–µ–π
- ESLint: ‚úÖ –ù–µ—Ç –æ—à–∏–±–æ–∫
```

#### 3. Testing

```bash
npx nx test user-management   # ‚úÖ –¢–µ—Å—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç
```

### üìã –ì–æ—Ç–æ–≤–Ω–æ—Å—Ç—å –∫ production:

#### 1. –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

- ‚úÖ Dockerfile –≥–æ—Ç–æ–≤
- ‚úÖ Docker Compose –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- ‚úÖ Environment variables
- ‚úÖ Health checks

#### 2. –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

- ‚úÖ Structured logging (Winston)
- ‚úÖ Health endpoint
- ‚úÖ Metrics –≥–æ—Ç–æ–≤—ã –∫ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏
- ‚úÖ Error tracking

#### 3. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ Keycloak –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è
- ‚úÖ JWT —Ç–æ–∫–µ–Ω—ã
- ‚úÖ Role-based access
- ‚úÖ Input validation

### üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

#### 1. –ì–æ—Ç–æ–≤—ã–µ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã:

- **DeviceManagement**: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ IoT —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞–º–∏
- **DataCollection**: –°–±–æ—Ä –∏ –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–ª–µ–º–µ—Ç—Ä–∏–∏
- **Notification**: –°–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
- **Analytics**: –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –∏ –æ—Ç—á–µ—Ç—ã
- **Gateway**: API Gateway

#### 2. Infrastructure:

- Kafka –∫–ª–∞—Å—Ç–µ—Ä –¥–ª—è —Å–æ–±—ã—Ç–∏–π
- PostgreSQL –∫–ª–∞—Å—Ç–µ—Ä –¥–ª—è –¥–∞–Ω–Ω—ã—Ö
- Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- EMQX –¥–ª—è MQTT

### üí° –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è:

1. **Event-Driven**: –í—Å–µ –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å—ã –æ–±—â–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ Kafka —Å–æ–±—ã—Ç–∏—è
2. **Database per Service**: –ö–∞–∂–¥—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –∏–º–µ–µ—Ç —Å–≤–æ—é –ë–î
3. **Shared Contracts**: –û–±—â–∏–µ —Ç–∏–ø—ã –∏ —Å—Ö–µ–º—ã –≤ `@iot-hub/contracts`
4. **API Gateway**: –ï–¥–∏–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞ –¥–ª—è –≤—Å–µ—Ö API
5. **Service Discovery**: Consul –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è —Å–µ—Ä–≤–∏—Å–æ–≤

## –°—Ç–∞—Ç—É—Å: ‚úÖ –ó–ê–í–ï–†–®–ï–ù–ê –£–°–ü–ï–®–ù–û

UserManagement –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∫ production —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏—é.
–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–∏–Ω—Ü–∏–ø—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã, —à–∞–±–ª–æ–Ω—ã –¥–ª—è —Å–ª–µ–¥—É—é—â–∏—Ö –∏—Ç–µ—Ä–∞—Ü–∏–π –≥–æ—Ç–æ–≤—ã.

---

_–°–æ–∑–¥–∞–Ω–æ: $(date)_
_NX Workspace: iot-hub_
_–¢–µ—Ö–Ω–æ–ª–æ–≥–∏–∏: NestJS, Drizzle ORM, PostgreSQL, Keycloak, Kafka_
