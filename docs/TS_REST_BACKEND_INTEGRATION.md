# Интеграция TS-REST контрактов в бэкэнд IoT Hub

## Обзор

Мы успешно интегрировали TS-REST контракты в контроллеры бэкэнда IoT Hub. Это обеспечивает типобезопасность между клиентом и сервером, автоматическую валидацию запросов и синхронизацию API.

## Выполненные изменения

### 1. Установка зависимостей

Добавлена зависимость `@ts-rest/nest` для интеграции TS-REST с NestJS.

### 2. Создание общих утилит

Созданы общие утилиты для работы с TS-REST:

#### `apps/backend/src/common/decorators/ts-rest.decorators.ts`

- `TsRestEndpoint` - декоратор для интеграции контрактов
- `TsRestPathParam` - декоратор для документирования параметров пути
- `TsRestBody` - декоратор для документирования тела запроса
- `TsRestResponse` - декоратор для документирования ответов

#### `apps/backend/src/common/types/ts-rest.types.ts`

- Переэкспорт основных типов из `@ts-rest/nest`
- Дополнительные типы для валидированных запросов и ответов

#### `apps/backend/src/common/index.ts`

- Индексный файл для удобного импорта утилит

### 3. Исправление схем контрактов

Исправлена схема пользователей для совместимости с базой данных:

```typescript
// В libs/contracts/users/src/lib/users-schemas.ts
planExpiresAt: z
  .preprocess((v) => v ? new Date(v as string) : null, z.date().nullable())
  .describe('Дата окончания подписки'),
```

### 4. Создание мапперов

Создан маппер для преобразования сущностей в DTO:

```typescript
// apps/backend/src/users/mappers/user.mapper.ts
export class UserMapper {
  static toResponseDto(user: User): UserResponseDto {
    return {
      ...user,
      planExpiresAt: user.planExpiresAt ?? null,
    };
  }
}
```

### 5. Обновление контроллеров

#### Users Controller

- Интегрированы контракты из `@iot-hub/users`
- Добавлены TS-REST декораторы для валидации и документации
- Использован маппер для преобразования типов

Пример:

```typescript
@Post()
@TsRestEndpoint('Создать нового пользователя')
@TsRestBody('Данные для создания пользователя')
@TsRestResponse(201, 'Пользователь успешно создан')
@TsRestHandler(usersContract.createUser)
async create(@Body() createUserDto: CreateUserDto): Promise<UserResponseDto> {
  const user = await this.usersService.create(createUserDto);
  return UserMapper.toResponseDto(user);
}
```

#### Devices Controller

- Интегрированы контракты из `@iot-hub/devices`
- Добавлены TS-REST декораторы для основных операций с устройствами

#### Certificates Controller

- Полностью переписан с использованием TS-REST декораторов
- Упрощена структура для лучшей совместимости
- Добавлены заглушки для методов, которые еще не реализованы

## Преимущества интеграции

### 1. Типобезопасность

- Автоматическая синхронизация типов между клиентом и сервером
- Предотвращение ошибок несоответствия типов на этапе компиляции

### 2. Автоматическая валидация

- Валидация запросов на основе Zod схем из контрактов
- Единообразная обработка ошибок валидации

### 3. Улучшенная документация

- Автоматическое создание Swagger документации на основе контрактов
- Синхронизация документации с реальной реализацией API

### 4. Упрощение разработки

- Единый источник истины для API контрактов
- Автоматическое обновление клиентского кода при изменении контрактов

## Структура файлов

```
apps/backend/src/
├── common/
│   ├── decorators/
│   │   └── ts-rest.decorators.ts
│   ├── types/
│   │   └── ts-rest.types.ts
│   └── index.ts
├── users/
│   ├── mappers/
│   │   └── user.mapper.ts
│   └── users.controller.ts (обновлен)
├── devices/
│   ├── devices.controller.ts (обновлен)
│   └── certificates.controller.ts (переписан)
└── mqtt/
    └── mqtt-rpc.controller.ts (оставлен без изменений)
```

## Сборка и тестирование

Проект успешно собирается без ошибок:

```bash
nx build @iot-hub/backend
# ✅ Successfully compiled
```

## Дальнейшие шаги

1. **Завершить интеграцию MQTT контроллера** - добавить TS-REST декораторы для MQTT RPC методов

2. **Создать клиентские SDK** - использовать контракты для генерации типобезопасных клиентов

3. **Добавить E2E тесты** - проверить корректность работы контрактов в реальных сценариях

4. **Реализовать недостающие методы** - завершить реализацию методов в CertificateService

5. **Добавить авторизацию на уровне контрактов** - интегрировать проверку прав доступа

## Заключение

Интеграция TS-REST контрактов успешно завершена для основных контроллеров бэкэнда. Это обеспечивает:

- Типобезопасность между клиентом и сервером
- Автоматическую валидацию запросов
- Улучшенную документацию API
- Единообразный подход к разработке API

Код готов к использованию и дальнейшему развитию.
