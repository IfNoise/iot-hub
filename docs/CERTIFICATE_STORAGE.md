# Централизованное хранение сертификатов в Docker

В этом проекте реализовано централизованное хранение сертификатов с использованием Docker Volume. Это позволяет:

1. Обеспечить постоянство хранения сертификатов между перезапусками контейнеров
2. Централизованно управлять сертификатами
3. Упростить доступ к одним и тем же сертификатам из разных контейнеров
4. Повысить безопасность за счет изоляции сертификатов от кода приложения

## Архитектура хранения сертификатов

- **Том Docker**: `iot-hub-certs` - именованный том для хранения сертификатов
- **Путь монтирования в EMQX**: `/opt/emqx/etc/certs` (только для чтения)
- **Путь монтирования в Backend**: `/workspace/certs` (чтение/запись)
- **Локальная директория для разработки**: `./certs`

## Файлы сертификатов

- `ca-cert.pem` - Сертификат Certificate Authority (CA) в формате PEM
- `ca-key-pkcs8.pem` - Приватный ключ CA в формате PKCS#8 PEM
- `server-cert.pem` - Серверный сертификат для EMQX
- `server-key.pem` - Приватный ключ сервера для EMQX

## Использование

### Инициализация тома сертификатов

Перед первым запуском системы необходимо инициализировать том сертификатами:

```bash
./scripts/init-certs-volume.sh
```

Этот скрипт проверит наличие сертификатов в локальной директории `./certs`, создаст Docker-том и скопирует сертификаты в этот том.

### Генерация новых сертификатов

Для генерации новых сертификатов используйте скрипт:

```bash
./scripts/generate-ca-certs.sh
```

После генерации новых сертификатов необходимо обновить том:

```bash
./scripts/init-certs-volume.sh
```

### Запуск системы

После инициализации тома сертификатов, вы можете запустить систему с помощью:

```bash
docker-compose up -d
```

## Проверка конфигурации

Для проверки конфигурации сертификатов используйте:

```bash
# Проверка содержимого тома
docker run --rm -v iot-hub-certs:/certs alpine ls -la /certs

# Проверка прав доступа к сертификатам в контейнере EMQX
docker exec emqx-mtls ls -la /opt/emqx/etc/certs

# Проверка прав доступа к сертификатам в контейнере Backend
docker exec iot-hub-backend ls -la /workspace/certs
```

## Безопасность

- Приватные ключи имеют права доступа 600 (чтение/запись только для владельца)
- Сертификаты имеют права доступа 644 (чтение для всех, запись только для владельца)
- Том монтируется в EMQX в режиме только для чтения
- Контейнер Backend имеет доступ на запись для генерации клиентских сертификатов

## Дополнительные рекомендации

1. В продакшн окружении рекомендуется использовать Docker Secrets или Kubernetes Secrets для хранения сертификатов
2. Регулярно создавайте резервные копии тома сертификатов
3. Настройте ротацию сертификатов и процедуру обновления
