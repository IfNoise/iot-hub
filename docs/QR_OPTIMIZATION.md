# Оптимизированный флоу привязки устройств через QR-коды

## Проблема с первоначальным подходом

Изначально планировалось включать в QR-код:

```json
{
  "deviceId": "ESP32-12345",
  "fingerprint": "AA:BB:CC:DD:EE:FF",
  "publicKey": "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA...\n-----END PUBLIC KEY-----",
  "model": "ESP32-DevKit-V1",
  "firmwareVersion": "1.0.0",
  "manufacturedAt": "2025-06-21T10:00:00.000Z"
}
```

**Проблемы:**

- Публичный ключ в PEM формате: 500+ символов
- Общий размер: 700+ символов
- Слишком сложный QR-код для надежного сканирования
- Избыточная информация

## Оптимизированные решения

### 1. Минимальный QR-код (70-80 символов)

```json
{
  "deviceId": "ESP32-12345",
  "fingerprint": "AA:BB:CC:DD:EE:FF",
  "v": 1
}
```

**Преимущества:**

- Самый компактный размер
- Простое сканирование
- Публичный ключ получается с сервера по deviceId

**Безопасность:** Средняя (зависит от безопасности канала получения публичного ключа)

### 2. QR-код с токеном привязки (80-90 символов) ⭐ **РЕКОМЕНДУЕМЫЙ**

```json
{
  "deviceId": "ESP32-12345",
  "bindingToken": "a1b2c3d4e5f6g7h8",
  "v": 1
}
```

**Преимущества:**

- Высокая безопасность (уникальный бессрочный токен)
- Компактный размер
- Токен можно отозвать
- Нет проблем с истечением срока действия

**Процесс:**

1. При производстве генерируется уникальный бессрочный токен
2. Пользователь сканирует QR-код
3. Сервер проверяет валидность токена
4. Привязка происходит только при валидном токене
5. После привязки токен становится недействительным

### 3. QR-код с хешем ключа (110-120 символов)

```json
{
  "deviceId": "ESP32-12345",
  "fingerprint": "AA:BB:CC:DD:EE:FF",
  "keyHash": "sha256-abc123def456",
  "v": 1
}
```

**Преимущества:**

- Компромисс между размером и безопасностью
- Дополнительная проверка через хеш ключа
- Защита от подмены устройств

## Новый API флоу

### Производственный процесс

```typescript
// 1. Генерация QR-кода для устройства
POST /manufacturing/generate-device-qr
{
  "deviceId": "ESP32-12345",
  "model": "ESP32-DevKit-V1",
  "firmwareVersion": "1.0.0",
  "publicKeyPem": "-----BEGIN PUBLIC KEY-----...",
  "qrType": "token" // или "minimal", "hash"
}

// Ответ:
{
  "message": "QR-код успешно сгенерирован",
  "data": {
    "deviceId": "ESP32-12345",
    "qrData": {
      "deviceId": "ESP32-12345",
      "bindingToken": "a1b2c3d4e5f6g7h8",
      "v": 1
    },
    "qrCodeBase64": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAA...",
    "bindingToken": "a1b2c3d4e5f6g7h8",
    "estimatedQRSize": 85
  }
}
```

### Пользовательский процесс

```typescript
// 1. Пользователь сканирует QR-код и отправляет данные
POST /devices/bind-qr
{
  "qrData": {
    "deviceId": "ESP32-12345",
    "bindingToken": "a1b2c3d4e5f6g7h8",
    "v": 1
  },
  "userId": "user-uuid-123"
}

// Ответ при успехе:
{
  "message": "Устройство успешно привязано",
  "device": {
    "deviceId": "ESP32-12345",
    "userId": "user-uuid-123",
    "boundAt": "2025-06-21T10:30:00.000Z",
    "status": "bound"
  }
}

// Ответ при ошибке:
{
  "message": "Неверный токен привязки",
  "code": "INVALID_QR"
}
```

### Валидация токена (опционально)

```typescript
// Проверка токена перед привязкой
GET /manufacturing/validate-token/ESP32-12345/a1b2c3d4e5f6g7h8

// Ответ:
{
  "isValid": true,
  "deviceExists": true,
  "canBind": true
}
```

## Сравнение размеров QR-кодов

| Тип QR-кода | Размер (символы) | Сложность QR  | Безопасность  | Рекомендация           |
| ----------- | ---------------- | ------------- | ------------- | ---------------------- |
| Изначальный | 700+             | Очень высокая | Высокая       | ❌ Слишком большой     |
| Минимальный | 70-80            | Низкая        | Средняя       | ✅ Для простых случаев |
| С токеном   | 80-90            | Низкая        | Очень высокая | ⭐ **Рекомендуется**   |
| С хешем     | 110-120          | Средняя       | Высокая       | ✅ Альтернатива        |

## Безопасность

### Токен-подход (рекомендуемый)

- ✅ Бессрочные токены до момента привязки
- ✅ Токены можно отозвать
- ✅ Каждый токен уникален
- ✅ Защита от повторного использования QR-кода
- ✅ Аудит попыток привязки
- ✅ Токен становится недействительным после привязки

### Минимальный подход

- ⚠️ Зависит от безопасности получения публичного ключа
- ✅ Fingerprint защищает от подмены сертификата
- ⚠️ QR-код может быть переиспользован

### Хеш-подход

- ✅ Дополнительная проверка целостности
- ✅ Защита от подмены публичного ключа
- ⚠️ Может быть переиспользован

## Реализация

Все три подхода реализованы в новых схемах:

- `qr-schemas.ts` - Zod схемы для всех типов QR-кодов
- `qr-contracts.ts` - REST API контракты
- Поддержка автоматического определения типа QR-кода
- Валидация и обработка ошибок для каждого типа
