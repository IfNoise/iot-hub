# Автоматическое создание пользователей

## Обзор

Система автоматически создает и синхронизирует пользователей при их первом появлении в системе. Это происходит через middleware, который обрабатывает каждый аутентифицированный запрос.

## Архитектура

### Компоненты

1. **AutoUserSyncMiddleware** (`src/common/middleware/auto-user-sync.middleware.ts`)

   - Middleware, который перехватывает каждый запрос с аутентифицированным пользователем
   - Автоматически вызывает синхронизацию пользователя
   - Не блокирует выполнение запроса при ошибках синхронизации

2. **KeycloakUserService** (`src/common/services/keycloak-user.service.ts`)

   - Сервис для работы с пользователями Keycloak
   - Предоставляет метод `syncUser()` для синхронизации данных
   - Логирует операции создания и обновления пользователей

3. **UsersService** (`src/users/users.service.ts`)
   - Основной сервис для работы с пользователями
   - Содержит метод `createOrUpdate()` для атомарного создания/обновления
   - Автоматически устанавливает значения по умолчанию для новых пользователей

### Поток выполнения

```plaintext
Запрос → KeycloakOAuth2Middleware → AutoUserSyncMiddleware → Контроллер
           ↓                         ↓
       Аутентификация           Синхронизация пользователя
       Keycloak                      ↓
                                KeycloakUserService.syncUser()
                                     ↓
                                UsersService.createOrUpdate()
                                     ↓
                                База данных
```

## Конфигурация

### Middleware настройка

Middleware настроен в `app.module.ts`:

```typescript
configure(consumer: MiddlewareConsumer) {
  // Keycloak authentication
  consumer
    .apply(KeycloakOAuth2Middleware)
    .exclude('/api', '/api/health', '/api/health/*', '/api/status')
    .forRoutes('*');

  // Auto user sync
  consumer
    .apply(AutoUserSyncMiddleware)
    .exclude('/api', '/api/health', '/api/health/*', '/api/status')
    .forRoutes('*');
}
```

### Значения по умолчанию для новых пользователей

При создании нового пользователя автоматически устанавливаются:

- `balance: 0` - Начальный баланс
- `plan: 'free'` - Бесплатный план
- `role: 'user'` - Роль по умолчанию (берется из Keycloak)

## Логирование

Система логирует следующие события:

- **DEBUG**: Начало и завершение синхронизации пользователя
- **LOG**: Создание нового пользователя
- **LOG**: Обновление существующего пользователя
- **ERROR**: Ошибки при синхронизации

Пример логов:

```plaintext
[AutoUserSyncMiddleware] Синхронизация пользователя: user@example.com
[KeycloakUserService] Пользователь синхронизирован: user@example.com (uuid)
```

## Безопасность

- Middleware применяется только к аутентифицированным маршрутам
- Исключаются публичные эндпоинты (`/api`, `/api/health`, `/api/status`)
- При ошибках синхронизации запрос продолжает выполняться с данными Keycloak
- Используется атомарная операция `createOrUpdate` для предотвращения дублирования

## Производительность

- Синхронизация происходит только при изменении данных пользователя
- Проверка изменений выполняется на уровне сервиса перед обращением к БД
- Операции логируются для мониторинга производительности
- Middleware не блокирует запрос при ошибках

## Тестирование

Для тестирования автоматического создания пользователей:

1. Запустите сервер: `npx nx serve @iot-hub/backend`
2. Выполните аутентифицированный запрос к любому эндпоинту
3. Проверьте логи для подтверждения синхронизации
4. Проверьте базу данных на наличие созданного пользователя

## Возможные проблемы и решения

### Проблема: Пользователь не создается

**Причины:**

- Ошибка в базе данных
- Неправильная конфигурация Keycloak
- Middleware не применен к маршруту

**Решение:**

- Проверьте логи на наличие ошибок
- Убедитесь, что маршрут не исключен из middleware
- Проверьте подключение к базе данных

### Проблема: Дублирование пользователей

**Причины:**

- Race condition при параллельных запросах
- Ошибка в логике `createOrUpdate`

**Решение:**

- Проверьте уникальные ограничения в базе данных
- Рассмотрите использование транзакций для критических операций

## Расширение функциональности

Для добавления дополнительной логики при создании пользователей:

1. Расширьте метод `createOrUpdate` в `UsersService`
2. Добавьте дополнительные поля в `CreateUserDto`
3. Обновите логику в `KeycloakUserService.syncUser()`
4. Добавьте соответствующие миграции базы данных
