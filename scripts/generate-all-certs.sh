#!/bin/bash

# Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð²ÑÐµÑ… ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² Ð´Ð»Ñ IoT Hub Ð² ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ PKCS#8
# ÐÐ²Ñ‚Ð¾Ñ€: IoT Hub Team
# Ð”Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ: $(date)

set -e

# Ð¦Ð²ÐµÑ‚Ð° Ð´Ð»Ñ Ð²Ñ‹Ð²Ð¾Ð´Ð°
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ
CERTS_DIR="./certs-new"
BACKUP_DIR="./backup-certs-$(date +%Y%m%d-%H%M%S)"

echo -e "${BLUE}ðŸ” Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÐºÐ¾Ð¼Ð¿Ð»ÐµÐºÑ‚Ð° ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² IoT Hub${NC}"
echo -e "${BLUE}=============================================${NC}"

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸
echo -e "${YELLOW}ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¹...${NC}"
mkdir -p "$CERTS_DIR"
mkdir -p "$BACKUP_DIR"

# Ð•ÑÐ»Ð¸ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÑŽÑ‚ ÑÑ‚Ð°Ñ€Ñ‹Ðµ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹, ÑÐ¾Ð·Ð´Ð°ÐµÐ¼ Ð±ÑÐºÐ°Ð¿
if [ -d "./certs" ] && [ "$(ls -A ./certs)" ]; then
    echo -e "${YELLOW}ðŸ’¾ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ñ€ÐµÐ·ÐµÑ€Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð¿Ð¸Ð¸ ÑÑ‚Ð°Ñ€Ñ‹Ñ… ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²...${NC}"
    cp -r ./certs/* "$BACKUP_DIR/" 2>/dev/null || true
    echo -e "${GREEN}âœ… Ð ÐµÐ·ÐµÑ€Ð²Ð½Ð°Ñ ÐºÐ¾Ð¿Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð°: $BACKUP_DIR${NC}"
fi

# ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
cd "$CERTS_DIR"

# =============================================================================
# 1. Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Root CA (Certificate Authority)
# =============================================================================

echo -e "${BLUE}ðŸ›ï¸  Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Root CA...${NC}"

# Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ CA Ð² PKCS#8 Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ
openssl genpkey -algorithm RSA -pkcs8 -out ca-key.pem -pkcs8 -pass pass: -cipher-bits 2048

# Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¿Ñ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
chmod 600 ca-key.pem

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ CA
cat > ca.conf << EOF
[req]
distinguished_name = req_distinguished_name
x509_extensions = v3_ca
prompt = no

[req_distinguished_name]
C = RU
ST = Moscow
L = Moscow
O = IoT Hub
OU = Certificate Authority
CN = IoT Hub Root CA
emailAddress = admin@iothub.local

[v3_ca]
basicConstraints = critical,CA:TRUE
keyUsage = critical,keyCertSign,cRLSign
subjectKeyIdentifier = hash
EOF

# Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ ÑÐ°Ð¼Ð¾Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ°Ð½Ð½Ñ‹Ð¹ CA ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚
openssl req -new -x509 -key ca-key.pem -out ca-cert.pem -days 3650 -config ca.conf -extensions v3_ca

echo -e "${GREEN}âœ… Root CA ÑÐ¾Ð·Ð´Ð°Ð½${NC}"

# =============================================================================
# 2. Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ð²ÐµÑ€Ð½Ð¾Ð³Ð¾ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð° Ð´Ð»Ñ EMQX
# =============================================================================

echo -e "${BLUE}ðŸŒ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ð²ÐµÑ€Ð½Ð¾Ð³Ð¾ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð° Ð´Ð»Ñ EMQX...${NC}"

# Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ ÑÐµÑ€Ð²ÐµÑ€Ð° Ð² PKCS#8 Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ
openssl genpkey -algorithm RSA -out server-key.pem -pkcs8 -pass pass: -cipher-bits 2048

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ ÑÐµÑ€Ð²ÐµÑ€Ð½Ð¾Ð³Ð¾ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
cat > server.conf << EOF
[req]
distinguished_name = req_distinguished_name
req_extensions = v3_req
prompt = no

[req_distinguished_name]
C = RU
ST = Moscow
L = Moscow
O = IoT Hub
OU = MQTT Broker
CN = localhost
emailAddress = mqtt@iothub.local

[v3_req]
keyUsage = keyEncipherment, dataEncipherment, digitalSignature, nonRepudiation
extendedKeyUsage = serverAuth
subjectAltName = @alt_names

[alt_names]
DNS.1 = localhost
DNS.2 = emqx
DNS.3 = emqx-mtls
DNS.4 = iot-emqx
IP.1 = 127.0.0.1
IP.2 = 172.20.0.2
IP.3 = 172.20.0.3
EOF

# Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ CSR Ð´Ð»Ñ ÑÐµÑ€Ð²ÐµÑ€Ð°
openssl req -new -key server-key.pem -out server.csr -config server.conf -extensions v3_req

# ÐŸÐ¾Ð´Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÐµÑ€Ð²ÐµÑ€Ð½Ñ‹Ð¹ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ CA
openssl x509 -req -in server.csr -CA ca-cert.pem -CAkey ca-key.pem -CAcreateserial -out server-cert.pem -days 365 -extensions v3_req -extfile server.conf

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ CSR Ñ„Ð°Ð¹Ð»
rm server.csr

echo -e "${GREEN}âœ… Ð¡ÐµÑ€Ð²ÐµÑ€Ð½Ñ‹Ð¹ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½${NC}"

# =============================================================================
# 3. Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ð³Ð¾ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
# =============================================================================

echo -e "${BLUE}ðŸ“± Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ñ‚ÐµÑÑ‚Ð¾Ð²Ð¾Ð³Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ð³Ð¾ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°...${NC}"

# Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ñ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° Ð² PKCS#8 Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ
openssl genpkey -algorithm RSA -out test-device-key.pem -pkcs8 -pass pass: -cipher-bits 2048

# Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¾Ð½Ð½Ñ‹Ð¹ Ñ„Ð°Ð¹Ð» Ð´Ð»Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ð³Ð¾ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°
cat > test-device.conf << EOF
[req]
distinguished_name = req_distinguished_name
req_extensions = v3_req
prompt = no

[req_distinguished_name]
C = RU
ST = Moscow
L = Moscow
O = IoT Hub
OU = Devices
CN = test-device-001
emailAddress = device@iothub.local

[v3_req]
keyUsage = digitalSignature, keyEncipherment
extendedKeyUsage = clientAuth
EOF

# Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ CSR Ð´Ð»Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
openssl req -new -key test-device-key.pem -out test-device.csr -config test-device.conf -extensions v3_req

# ÐŸÐ¾Ð´Ð¿Ð¸ÑÑ‹Ð²Ð°ÐµÐ¼ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ð¹ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ Ñ Ð¿Ð¾Ð¼Ð¾Ñ‰ÑŒÑŽ CA
openssl x509 -req -in test-device.csr -CA ca-cert.pem -CAkey ca-key.pem -CAcreateserial -out test-device-cert.pem -days 365 -extensions v3_req -extfile test-device.conf

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ CSR Ñ„Ð°Ð¹Ð»
rm test-device.csr

echo -e "${GREEN}âœ… Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ð¹ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚ ÑÐ¾Ð·Ð´Ð°Ð½${NC}"

# =============================================================================
# 4. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°
# =============================================================================

echo -e "${BLUE}ðŸ”’ Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð¿Ñ€Ð°Ð² Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð°...${NC}"

# ÐŸÑ€Ð¸Ð²Ð°Ñ‚Ð½Ñ‹Ðµ ÐºÐ»ÑŽÑ‡Ð¸ - Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ† Ð¼Ð¾Ð¶ÐµÑ‚ Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ
chmod 600 *.pem | grep -E "(key|private)" || true
chmod 600 ca-key.pem server-key.pem test-device-key.pem

# Ð¡ÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ - Ð²Ð»Ð°Ð´ÐµÐ»ÐµÑ† Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ð° Ð¼Ð¾Ð³ÑƒÑ‚ Ñ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ
chmod 644 *.pem | grep -E "(cert|crt)" || true
chmod 644 ca-cert.pem server-cert.pem test-device-cert.pem

# Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹
rm -f *.conf *.csr *.srl

echo -e "${GREEN}âœ… ÐŸÑ€Ð°Ð²Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹${NC}"

# =============================================================================
# 5. ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²
# =============================================================================

echo -e "${BLUE}ðŸ” ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð²...${NC}"

echo -e "${YELLOW}ðŸ“‹ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ CA ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ðµ:${NC}"
openssl x509 -in ca-cert.pem -text -noout | head -20

echo -e "${YELLOW}ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÑÐµÑ€Ð²ÐµÑ€Ð½Ð¾Ð³Ð¾ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°:${NC}"
openssl verify -CAfile ca-cert.pem server-cert.pem

echo -e "${YELLOW}ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ð³Ð¾ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð°:${NC}"
openssl verify -CAfile ca-cert.pem test-device-cert.pem

echo -e "${YELLOW}ðŸ“‹ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¾Ð² ÐºÐ»ÑŽÑ‡ÐµÐ¹:${NC}"
echo "CA ÐºÐ»ÑŽÑ‡ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚:"
head -1 ca-key.pem
echo "Ð¡ÐµÑ€Ð²ÐµÑ€Ð½Ñ‹Ð¹ ÐºÐ»ÑŽÑ‡ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚:"
head -1 server-key.pem
echo "ÐšÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¸Ð¹ ÐºÐ»ÑŽÑ‡ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚:"
head -1 test-device-key.pem

# Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ÑÑ Ð² ÐºÐ¾Ñ€Ð½ÐµÐ²ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
cd ..

# =============================================================================
# 6. Ð˜Ñ‚Ð¾Ð³Ð¾Ð²Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ
# =============================================================================

echo -e "${GREEN}ðŸŽ‰ Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ð¾Ð² Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!${NC}"
echo -e "${GREEN}============================================${NC}"
echo ""
echo -e "${BLUE}ðŸ“ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ðµ Ñ„Ð°Ð¹Ð»Ñ‹ Ð² Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸ $CERTS_DIR:${NC}"
ls -la "$CERTS_DIR"
echo ""
echo -e "${BLUE}ðŸ”§ Ð¡Ð»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ðµ ÑˆÐ°Ð³Ð¸:${NC}"
echo -e "${YELLOW}1. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ backend Ð´Ð»Ñ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð½Ð¾Ð²Ð¾Ð¹ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸Ð¸${NC}"
echo -e "${YELLOW}2. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ docker-compose.yml Ð´Ð»Ñ Ð¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ $CERTS_DIR${NC}"
echo -e "${YELLOW}3. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ EMQX ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸ÑŽ${NC}"
echo -e "${YELLOW}4. ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð²ÑÐµ ÑÐµÑ€Ð²Ð¸ÑÑ‹${NC}"
echo ""
echo -e "${GREEN}âœ… Ð’ÑÐµ ÑÐµÑ€Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ‚Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÑŽÑ‚ ÑÐ¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ PKCS#8 Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚!${NC}"
